# PyBind11 Module CMakeLists.txt

cmake_minimum_required(VERSION 3.15)
project(GunMayhemPython)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Set source directory (parent of build_pybind)
set(SOURCE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/..)

# Find Python
find_package(Python COMPONENTS Interpreter Development REQUIRED)

# Download pybind11 if not found
include(FetchContent)
FetchContent_Declare(
    pybind11
    GIT_REPOSITORY https://github.com/pybind/pybind11.git
    GIT_TAG v2.11.1
)
FetchContent_MakeAvailable(pybind11)

# Collect source files (exclude main.cpp for the module)
file(GLOB_RECURSE LIB_SOURCES
    "${SOURCE_DIR}/src/*.cpp"
)
list(REMOVE_ITEM LIB_SOURCES "${SOURCE_DIR}/src/python_bindings.cpp")
list(REMOVE_ITEM LIB_SOURCES "${SOURCE_DIR}/main.cpp")

# SDL2 setup
set(SDL2_DIR ${SOURCE_DIR}/libs/SDL2-2.32.8/x86_64-w64-mingw32)
set(JSON_DIR ${SOURCE_DIR}/libs/nlohmannjson)
set(SDL2_TTF_DIR ${SOURCE_DIR}/libs/SDL2_ttf-2.24.0/x86_64-w64-mingw32)

# Create Python module
pybind11_add_module(gunmayhem 
    ${SOURCE_DIR}/src/python_bindings.cpp
    ${LIB_SOURCES}
)

# Include directories
target_include_directories(gunmayhem PRIVATE
    ${SOURCE_DIR}/include
    ${SDL2_DIR}/include/SDL2
    ${JSON_DIR}/include
    ${SDL2_TTF_DIR}/include/SDL2
)

# Link SDL2 libraries
target_link_directories(gunmayhem PRIVATE
    ${SDL2_DIR}/lib
    ${SDL2_TTF_DIR}/lib
)

target_link_libraries(gunmayhem PRIVATE
    SDL2
    SDL2main
    SDL2_ttf
)

# Copy DLLs to output directory
add_custom_command(TARGET gunmayhem POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E copy_if_different
        ${SDL2_DIR}/bin/SDL2.dll
        $<TARGET_FILE_DIR:gunmayhem>
    COMMAND ${CMAKE_COMMAND} -E copy_if_different
        ${SDL2_TTF_DIR}/bin/SDL2_ttf.dll
        $<TARGET_FILE_DIR:gunmayhem>
)
